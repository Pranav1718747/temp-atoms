<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåä ClimateSync - Environmental Alerts</title>
    <link rel="stylesheet" href="alerts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Animated Background -->
    <div class="background-animation">
        <div class="floating-particles"></div>
        <div class="gradient-overlay"></div>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
      <select id="languageSelect" onchange="changeLanguage()">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
        <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
        <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
        <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
        <option value="ur">ÿßÿ±ÿØŸà (Urdu)</option>
      </select>
    </div>

    <!-- Header Section -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="logo-text">
                    <h1 data-i18n="environmentalAlerts">Environmental Alerts</h1>
                    <p data-i18n="aiPoweredMonitoring">AI-Powered Climate Risk Monitoring</p>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span data-i18n="realTimeMonitoring">Real-time Monitoring</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="navigation">
        <div class="nav-container">
            <a href="index.html" class="nav-button">
                <i class="fas fa-cloud-sun"></i>
                <span data-i18n="weatherDashboard">Weather Dashboard</span>
            </a>
            <a href="farming.html" class="nav-button">
                <i class="fas fa-seedling"></i>
                <span data-i18n="farmersDashboard">Farmer's Dashboard</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="alert-section">


        <!-- Location Search Section -->
        <section class="location-search-section">
            <div class="location-search-container">
                <div class="search-header">
                    <h3><i class="fas fa-map-marker-alt"></i> <span data-i18n="selectLocation">Select Location</span></h3>
                    <p data-i18n="chooseLocationForEnvironmentalData">Choose a location to view environmental data</p>
                </div>
                <div class="search-controls">
                    <div class="search-input-wrapper">
                        <input type="text" id="locationSearchAlerts" placeholder="Search villages, towns, cities..." class="location-search-input">
                        <button onclick="searchLocationAlerts()" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <select id="citySelectAlerts" class="city-select" onchange="selectLocationAlerts()">
                        <option value="">üè° Select a location</option>
                    </select>
                </div>
                <div id="searchResultsAlerts" class="search-results"></div>
                <div class="current-location-display">
                    <div class="location-info">
                        <h4 id="currentLocationNameAlerts">Delhi</h4>
                        <p id="currentLocationTypeAlerts">Select a location to view data</p>
                    </div>
                    <button onclick="refreshEnvironmentalData()" class="refresh-btn" id="refreshEnvironmentalBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span data-i18n="refresh">Refresh</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Current Weather & Environmental Conditions -->
        <section class="environmental-conditions-section">
            <h2><i class="fas fa-thermometer-half"></i> <span data-i18n="currentEnvironmentalConditions">Current Environmental Conditions</span></h2>
            <div class="environmental-grid">
                <!-- Temperature Card -->
                <div class="env-card temperature-card">
                    <div class="env-card-header">
                        <div class="env-icon">üå°Ô∏è</div>
                        <h3 data-i18n="temperature">Temperature</h3>
                    </div>
                    <div class="env-value" id="envTemperature">--¬∞C</div>
                    <div class="env-status" id="envTempStatus" data-i18n="loading">Loading...</div>
                    <div class="temp-range">
                        <span data-i18n="min">Min: <span id="tempMin">--</span>¬∞C</span>
                        <span data-i18n="max">Max: <span id="tempMax">--</span>¬∞C</span>
                    </div>
                </div>

                <!-- Humidity Card -->
                <div class="env-card humidity-card">
                    <div class="env-card-header">
                        <div class="env-icon">üíß</div>
                        <h3 data-i18n="humidity">Humidity</h3>
                    </div>
                    <div class="env-value" id="envHumidity">--%</div>
                    <div class="env-status" id="envHumidityStatus" data-i18n="loading">Loading...</div>
                    <div class="humidity-visual">
                        <div class="humidity-bar">
                            <div class="humidity-fill" id="humidityFillBar"></div>
                        </div>
                    </div>
                </div>

                <!-- Rainfall Card -->
                <div class="env-card rainfall-card">
                    <div class="env-card-header">
                        <div class="env-icon">üåßÔ∏è</div>
                        <h3 data-i18n="rainfall">Rainfall</h3>
                    </div>
                    <div class="env-value" id="envRainfall">-- mm</div>
                    <div class="env-status" id="envRainfallStatus" data-i18n="loading">Loading...</div>
                    <div class="rainfall-indicator">
                        <div class="rain-level" id="rainLevelIndicator"></div>
                    </div>
                </div>

                <!-- Air Quality Card -->
                <div class="env-card air-quality-card">
                    <div class="env-card-header">
                        <div class="env-icon">üå´Ô∏è</div>
                        <h3 data-i18n="airQuality">Air Quality</h3>
                    </div>
                    <div class="env-value" id="envAQI">--</div>
                    <div class="env-status" id="envAQIStatus" data-i18n="loading">Loading...</div>
                    <div class="aqi-indicator">
                        <div class="aqi-level" id="aqiLevelIndicator"></div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Alert Cards Grid -->
        <section class="alerts-grid">
            <div class="grid-header">
                <h2>üö® <span data-i18n="currentAlertStatus">Current Alert Status</span></h2>
                <p data-i18n="monitorConditions">Monitor real-time environmental conditions and risks</p>
            </div>

            <div class="alert-cards-container">
                <div class="alert-card heatwave" data-alert-type="heatwave">
                    <div class="alert-background">
                        <div class="animated-bg heatwave-bg"></div>
                    </div>
                    <div class="alert-header">
                        <div class="alert-icon-container">
                            <div class="alert-icon">
                                <i class="fas fa-thermometer-full"></i>
                            </div>
                            <div class="icon-glow heatwave-glow"></div>
                        </div>
                        <div class="alert-title-section">
                            <h3 class="alert-title" data-i18n="heatwaveAlert">Heatwave Alert</h3>
                            <div class="alert-badge high-risk" data-i18n="highRisk">High Risk</div>
                        </div>
                    </div>
                    <div class="alert-content">
                        <div class="alert-stats">
                            <div class="stat-item">
                                <i class="fas fa-temperature-high"></i>
                                <span class="stat-value">38¬∞C</span>
                                <span class="stat-label" data-i18n="current">Current</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-clock"></i>
                                <span class="stat-value">7 days</span>
                                <span class="stat-label" data-i18n="duration">Duration</span>
                            </div>
                        </div>
                        <div class="alert-info" id="heatwave-info">
                            <p data-i18n="loadingComprehensiveHeatwaveAnalysis">Loading comprehensive heatwave analysis...</p>
                        </div>
                    </div>
                    <div class="alert-actions">
                        <button class="action-btn primary" onclick="getHeatwaveAlert()">
                            <i class="fas fa-search"></i>
                            <span data-i18n="analyzeRisk">Analyze Risk</span>
                        </button>
                    </div>
                </div>

                <div class="alert-card flood" data-alert-type="flood">
                    <div class="alert-background">
                        <div class="animated-bg flood-bg"></div>
                    </div>
                    <div class="alert-header">
                        <div class="alert-icon-container">
                            <div class="alert-icon">
                                <i class="fas fa-water"></i>
                            </div>
                            <div class="icon-glow flood-glow"></div>
                        </div>
                        <div class="alert-title-section">
                            <h3 class="alert-title" data-i18n="floodPrediction">Flood Prediction</h3>
                            <div class="alert-badge moderate-risk" data-i18n="moderateRisk">Moderate Risk</div>
                        </div>
                    </div>
                    <div class="alert-content">
                        <div class="alert-stats">
                            <div class="stat-item">
                                <i class="fas fa-tint"></i>
                                <span class="stat-value">9.5m</span>
                                <span class="stat-label" data-i18n="riverLevel">River Level</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-clock"></i>
                                <span class="stat-value">48h</span>
                                <span class="stat-label" data-i18n="peakTime">Peak Time</span>
                            </div>
                        </div>
                        <div class="alert-info" id="flood-info">
                            <p data-i18n="loadingFloodPredictionModels">Loading flood prediction models...</p>
                        </div>
                    </div>
                    <div class="alert-actions">
                        <button class="action-btn primary" onclick="getFloodPrediction()">
                            <i class="fas fa-waves"></i>
                            <span data-i18n="checkStatus">Check Status</span>
                        </button>
                    </div>
                </div>

                <div class="alert-card drought" data-alert-type="drought">
                    <div class="alert-background">
                        <div class="animated-bg drought-bg"></div>
                    </div>
                    <div class="alert-header">
                        <div class="alert-icon-container">
                            <div class="alert-icon">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <div class="icon-glow drought-glow"></div>
                        </div>
                        <div class="alert-title-section">
                            <h3 class="alert-title" data-i18n="droughtWarning">Drought Warning</h3>
                            <div class="alert-badge low-risk" data-i18n="lowRisk">Low Risk</div>
                        </div>
                    </div>
                    <div class="alert-content">
                        <div class="alert-stats">
                            <div class="stat-item">
                                <i class="fas fa-percentage"></i>
                                <span class="stat-value">12%</span>
                                <span class="stat-label" data-i18n="soilMoisture">Soil Moisture</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-calendar"></i>
                                <span class="stat-value">3 months</span>
                                <span class="stat-label" data-i18n="duration">Duration</span>
                            </div>
                        </div>
                        <div class="alert-info" id="drought-info">
                            <p data-i18n="loadingDroughtAssessmentData">Loading drought assessment data...</p>
                        </div>
                    </div>
                    <div class="alert-actions">
                        <button class="action-btn primary" onclick="getDroughtWarning()">
                            <i class="fas fa-sun"></i>
                            <span data-i18n="assessRisk">Assess Risk</span>
                        </button>
                    </div>
                </div>

                <div class="alert-card coastal" data-alert-type="coastal">
                    <div class="alert-background">
                        <div class="animated-bg coastal-bg"></div>
                    </div>
                    <div class="alert-header">
                        <div class="alert-icon-container">
                            <div class="alert-icon">
                                <i class="fas fa-ship"></i>
                            </div>
                            <div class="icon-glow coastal-glow"></div>
                        </div>
                        <div class="alert-title-section">
                            <h3 class="alert-title" data-i18n="coastalMonitoring">Coastal Monitoring</h3>
                            <div class="alert-badge medium-risk" data-i18n="mediumRisk">Medium Risk</div>
                        </div>
                    </div>
                    <div class="alert-content">
                        <div class="alert-stats">
                            <div class="stat-item">
                                <i class="fas fa-arrow-up"></i>
                                <span class="stat-value">1.2m</span>
                                <span class="stat-label" data-i18n="stormSurge">Storm Surge</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-water"></i>
                                <span class="stat-value">4m</span>
                                <span class="stat-label" data-i18n="waveHeight">Wave Height</span>
                            </div>
                        </div>
                        <div class="alert-info" id="coastal-info">
                            <p data-i18n="loadingCoastalMonitoringSystems">Loading coastal monitoring systems...</p>
                        </div>
                    </div>
                    <div class="alert-actions">
                        <button class="action-btn primary" onclick="getCoastalMonitoring()">
                            <i class="fas fa-binoculars"></i>
                            <span data-i18n="monitorCoast">Monitor Coast</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // =============== IMMEDIATE LOADING AND PROGRESSIVE ENHANCEMENT ===============
        
        // Progressive loading configuration for instant feedback
        const PROGRESSIVE_CONFIG = {
            instantFeedback: true,
            maxLoadTime: 3000,        // 3 seconds max before fallback
            chunkSize: 5,             // Load 5 cities at a time
            immediateDisplay: true,   // Show UI immediately
            backgroundLoading: true   // Continue loading in background
        };
        
        // Immediate UI initialization (runs instantly)
        function initializeImmediateUI() {
            console.log('‚ö° Instant UI initialization...');
            
            // Show immediate loading message
            updateDashboardStatus('connecting', 'Initializing...');
            
            // Pre-populate with sample data immediately
            showInstantSampleData();
            
            // Enable UI interactions immediately
            enableImmediateInteractions();
            
            // Start background data loading
            setTimeout(loadRealDataProgressively, 100);
        }
        
        // Show instant sample data for immediate feedback
        function showInstantSampleData() {
            console.log('üöÄ Showing instant sample data...');
            
            // Populate dropdown with sample locations immediately
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = `
                <option value="">üè° Select a small town/village</option>
                <option value="sample_mandla">üè° Mandla (Sample - Loading real data...)</option>
                <option value="sample_dharamshala">‚õ∞Ô∏è Dharamshala (Sample - Loading real data...)</option>
                <option value="sample_raichur">üè° Raichur (Sample - Loading real data...)</option>
            `;
            
            // Show sample environmental data immediately
            const sampleData = {
                temperature: 28,
                temp_min: 22,
                temp_max: 34,
                humidity: 65,
                rainfall: 2.5,
                air_quality_index: 95
            };
            
            updateEnvironmentalDisplay(sampleData, true); // Mark as sample data
            
            // Update status
            document.getElementById('currentLocationName').textContent = 'Sample Location';
            document.getElementById('currentLocationType').textContent = 'Loading real data...';
            
            updateDashboardStatus('connecting', 'Sample data loaded');
        }
        
        // Enable immediate UI interactions
        function enableImmediateInteractions() {
            console.log('üîÑ Enabling immediate interactions...');
            
            // Add loading overlay functionality
            addLoadingOverlay();
            
            // Add instant search functionality
            const searchInput = document.getElementById('locationSearch');
            if (searchInput) {
                searchInput.placeholder = 'Search (loading locations...)';
                searchInput.disabled = false;
            }
            
            // Add immediate feedback to buttons
            const generateBtn = document.getElementById('generateAlertsBtn');
            if (generateBtn) {
                generateBtn.onclick = function() {
                    console.log('Loading alert predictions...');
                    setTimeout(loadAlertPredictions, 100);
                };
            }
        }
        
        // Add loading overlay for better UX
        function addLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'dashboardLoadingOverlay';
            overlay.className = 'dashboard-loading-overlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                    </div>
                    <h3 data-i18n="climateSyncLoading">Climate-Sync Loading...</h3>
                    <p id="loadingMessage" data-i18n="initializingDashboard">Initializing dashboard...</p>
                    <div class="loading-progress">
                        <div class="progress-bar" id="loadingProgress"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Auto-hide after showing sample data
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }, 1500);
        }
        
        // Progressive data loading (loads real data in chunks)
        async function loadRealDataProgressively() {
            console.log('üîÑ Starting progressive data loading...');
            
            try {
                updateLoadingProgress(20, 'Loading small towns...');
                
                // Load cities with immediate timeout
                const citiesPromise = Promise.race([
                    loadSmallTownsOptimized(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), PROGRESSIVE_CONFIG.maxLoadTime)
                    )
                ]);
                
                await citiesPromise;
                updateLoadingProgress(60, 'Towns loaded successfully');
                
                // Auto-select first real city
                setTimeout(() => {
                    if (availableCities.length > 0) {
                        selectRealCity(availableCities[0]);
                        updateLoadingProgress(100, 'Dashboard ready');
                    }
                }, 500);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Progressive loading failed, using sample data:', error.message);
                updateLoadingProgress(100, 'Using sample data');
            }
        }
        
        // Optimized small towns loading
        async function loadSmallTownsOptimized() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000); // 2 second timeout
            
            try {
                const response = await fetch('http://localhost:4001/api/weather/cities', {
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'max-age=300' // 5 minute cache
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    availableCities = data.data;
                    populateCityDropdownOptimized(availableCities);
                    updateDashboardStatus('connected', 'Real data loaded');
                    console.log('‚úÖ Optimized loading: ' + availableCities.length + ' cities');
                    return true;
                } else {
                    throw new Error('No city data');
                }
                
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        // Optimized dropdown population
        function populateCityDropdownOptimized(cities) {
            const citySelect = document.getElementById('citySelect');
            const fragment = document.createDocumentFragment();
            
            // Clear sample data
            citySelect.innerHTML = '<option value="">üè° Select a small town/village</option>';
            
            // Add cities in chunks to avoid blocking
            const chunks = [];
            for (let i = 0; i < cities.length; i += PROGRESSIVE_CONFIG.chunkSize) {
                chunks.push(cities.slice(i, i + PROGRESSIVE_CONFIG.chunkSize));
            }
            
            chunks.forEach((chunk, index) => {
                setTimeout(() => {
                    chunk.forEach(city => {
                        const option = document.createElement('option');
                        const typeIcon = getLocationTypeIcon(city.type);
                        option.value = city.name;
                        option.textContent = `${typeIcon} ${city.name} (${city.state})`;
                        option.dataset.cityData = JSON.stringify(city);
                        fragment.appendChild(option);
                    });
                    
                    if (index === 0) {
                        citySelect.appendChild(fragment);
                    }
                }, index * 50); // Stagger loading
            });
        }
        
        // Select real city data
        function selectRealCity(city) {
            const citySelect = document.getElementById('citySelect');
            citySelect.value = city.name;
            
            document.getElementById('currentLocationName').textContent = city.name;
            document.getElementById('currentLocationType').textContent = `${city.type}, ${city.state}`;
            
            // Load real environmental data with fallback
            loadEnvironmentalDataOptimized(city.name);
        }
        
        // Optimized environmental data loading
        async function loadEnvironmentalDataOptimized(cityName) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);
            
            try {
                updateDashboardStatus('connecting', `Loading ${cityName}...`);
                
                const response = await fetch(`http://localhost:4001/api/weather/current/${cityName}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        updateEnvironmentalDisplay(data.data);
                        updateDashboardStatus('connected', 'Real data updated');
                        return;
                    }
                }
                
                throw new Error('No weather data');
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.warn(`‚ö†Ô∏è Weather data failed for ${cityName}, keeping sample data`);
                updateDashboardStatus('disconnected', 'Using sample data');
            }
        }
        

        
        // Update loading progress
        function updateLoadingProgress(percent, message) {
            const progressBar = document.getElementById('loadingProgress');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
        }
        

        

        
        // Update dashboard status indicator
        function updateDashboardStatus(status, message) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const forceUpdateBtn = document.getElementById('forceUpdateBtn');
            
            if (statusDot && statusText) {
                statusDot.className = `status-dot ${status}`;
                statusText.textContent = message;
                
                // Show force update button if disconnected
                if (forceUpdateBtn) {
                    if (status === 'disconnected' || status === 'connecting') {
                        forceUpdateBtn.classList.add('show');
                    } else {
                        forceUpdateBtn.classList.remove('show');
                    }
                }
            }
        }
        
        // Enhanced load small towns with status updates
        async function loadSmallTowns() {
            try {
                updateDashboardStatus('connecting', 'Loading...');
                showLoadingState('Loading locations...');
                
                const response = await retryWithBackoff(async () => {
                    return await fetchWithTimeout('http://localhost:4001/api/weather/cities', {}, DASHBOARD_CONFIG.timeouts.dataLoad);
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    availableCities = data.data;
                    populateCityDropdown(availableCities);
                    updateDashboardStatus('connected', 'Connected');
                    console.log('‚úÖ Loaded small towns:', availableCities.length);
                    
                    // Auto-select first city for demo
                    if (availableCities.length > 0) {
                        setTimeout(() => {
                            selectFirstCity();
                        }, 1000);
                    }
                } else {
                    throw new Error(data.error || 'No city data received');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load cities:', error.message);
                updateDashboardStatus('disconnected', 'Connection Failed');
                
                // Use fallback cities data
                availableCities = getFallbackCities();
                populateCityDropdown(availableCities);
                
                console.log('Using fallback data');
                console.warn('Using fallback cities data');
            }
        }
        
        // Get fallback cities data
        function getFallbackCities() {
            return [
                { id: 1, name: 'Mandla', state: 'Madhya Pradesh', type: 'Town', economic_activity: 'Agriculture, Tribal crafts' },
                { id: 2, name: 'Dharamshala', state: 'Himachal Pradesh', type: 'Hill Station', economic_activity: 'Tourism, Tea cultivation' },
                { id: 3, name: 'Raichur', state: 'Karnataka', type: 'Town', economic_activity: 'Cotton farming, Mining' },
                { id: 4, name: 'Darjeeling', state: 'West Bengal', type: 'Hill Station', economic_activity: 'Tea cultivation, Tourism' },
                { id: 5, name: 'Jaisalmer', state: 'Rajasthan', type: 'Desert Town', economic_activity: 'Tourism, Traditional crafts' }
            ];
        }
        
        // Auto-select first city
        function selectFirstCity() {
            if (availableCities.length > 0) {
                const firstCity = availableCities[0];
                const citySelect = document.getElementById('citySelect');
                citySelect.value = firstCity.name;
                
                document.getElementById('currentLocationName').textContent = firstCity.name;
                document.getElementById('currentLocationType').textContent = `${firstCity.type}, ${firstCity.state}`;
                
                loadEnvironmentalData(firstCity.name);
            }
        }
        
        // Enhanced load environmental data with timeout and fallback
        async function loadEnvironmentalData(cityName) {
            if (!cityName) return;
            
            try {
                showLoadingState(`Loading ${cityName} data...`);
                
                const response = await retryWithBackoff(async () => {
                    return await fetchWithTimeout(
                        `http://localhost:4001/api/weather/current/${cityName}`,
                        {},
                        DASHBOARD_CONFIG.timeouts.dataLoad
                    );
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    updateEnvironmentalDisplay(data.data);
                    currentLocationData = data.data;
                    dashboardState.lastSuccessfulLoad = Date.now();
                    console.log(`‚úÖ Environmental data loaded for ${cityName}`);
                } else {
                    throw new Error(data.error || 'No weather data received');
                }
                
            } catch (error) {
                console.error(`‚ùå Failed to load environmental data for ${cityName}:`, error.message);
                console.log('Using fallback data');
            } finally {
                dashboardState.isLoading = false;
            }
        }
        
        // Populate city dropdown with small towns data
        function populateCityDropdown(cities) {
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="">üè° Select a small town/village</option>';
            
            cities.forEach(city => {
                const typeIcon = getLocationTypeIcon(city.type);
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = `${typeIcon} ${city.name} (${city.state})`;
                option.dataset.cityData = JSON.stringify(city);
                citySelect.appendChild(option);
            });
        }
        
        // Get icon based on location type
        function getLocationTypeIcon(type) {
            const icons = {
                'Town': 'üèòÔ∏è',
                'Hill Station': '‚õ∞Ô∏è',
                'Hill Town': 'üèîÔ∏è',
                'Desert Town': 'üèúÔ∏è',
                'Coastal Town': 'üèñÔ∏è',
                'Tribal Town': 'üåø',
                'Border Town': 'üîÜ',
                'Mountain Town': 'üóª',
                'High Altitude Town': 'üèîÔ∏è'
            };
            return icons[type] || 'üèòÔ∏è';
        }
        
        // Search location functionality
        async function searchLocation() {
            const searchInput = document.getElementById('locationSearch');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a location to search');
                return;
            }
            
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="search-loading">üîç Searching...</div>';
            searchResults.style.display = 'block';
            
            try {
                // Search in loaded cities first
                const localResults = availableCities.filter(city => 
                    city.name.toLowerCase().includes(query.toLowerCase()) ||
                    city.state.toLowerCase().includes(query.toLowerCase()) ||
                    city.district.toLowerCase().includes(query.toLowerCase())
                );
                
                displaySearchResults(localResults);
                
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="search-error">‚ùå Search failed</div>';
            }
        }
        
        // Display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results">‚ùå No locations found</div>';
                return;
            }
            
            let html = '';
            results.forEach(city => {
                const typeIcon = getLocationTypeIcon(city.type);
                html += `
                    <div class="search-result-item" onclick="selectSearchResult('${city.name}', '${city.type}', '${city.state}')">
                        <div class="result-icon">${typeIcon}</div>
                        <div class="result-info">
                            <div class="result-name">${city.name}</div>
                            <div class="result-details">${city.state} ‚Ä¢ ${city.type}</div>
                            <div class="result-activity">${city.economic_activity}</div>
                        </div>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
        }
        
        // Select search result
        function selectSearchResult(cityName, cityType, stateName) {
            document.getElementById('locationSearch').value = cityName;
            document.getElementById('citySelect').value = cityName;
            document.getElementById('searchResults').style.display = 'none';
            
            // Update current location display
            document.getElementById('currentLocationName').textContent = cityName;
            document.getElementById('currentLocationType').textContent = `${cityType}, ${stateName}`;
            
            // Load environmental data for selected location
            loadEnvironmentalData(cityName);
        }
        
        // Enhanced load environmental data with timeout and fallback
        async function loadEnvironmentalData(cityName) {
            if (!cityName) return;
            
            try {
                showLoadingState(`Loading ${cityName} data...`);
                
                const response = await retryWithBackoff(async () => {
                    return await fetchWithTimeout(
                        `http://localhost:4001/api/weather/current/${cityName}`,
                        {},
                        DASHBOARD_CONFIG.timeouts.dataLoad
                    );
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    updateEnvironmentalDisplay(data.data);
                    currentLocationData = data.data;
                    dashboardState.lastSuccessfulLoad = Date.now();
                    console.log(`‚úÖ Environmental data loaded for ${cityName}`);
                } else {
                    throw new Error(data.error || 'No weather data received');
                }
                
            } catch (error) {
                console.error(`‚ùå Failed to load environmental data for ${cityName}:`, error.message);
                console.log('Using fallback data');
            } finally {
                dashboardState.isLoading = false;
            }
        }
        
        // Update environmental conditions display with instant feedback
        function updateEnvironmentalDisplay(weatherData, isSampleData = false) {
            const statusClass = isSampleData ? 'sample-data' : 'real-data';
            
            // Add instant animation
            const cards = document.querySelectorAll('.env-card');
            cards.forEach(card => card.classList.add('instant-load'));
            
            // Temperature
            if (weatherData.temperature !== undefined) {
                document.getElementById('envTemperature').textContent = `${weatherData.temperature.toFixed(1)}¬∞C`;
                document.getElementById('tempMin').textContent = weatherData.temp_min?.toFixed(1) || '--';
                document.getElementById('tempMax').textContent = weatherData.temp_max?.toFixed(1) || '--';
                
                const tempStatus = getTemperatureStatus(weatherData.temperature);
                const tempStatusEl = document.getElementById('envTempStatus');
                tempStatusEl.textContent = tempStatus.text;
                tempStatusEl.className = `env-status ${tempStatus.class} ${statusClass}`;
            }
            
            // Humidity
            if (weatherData.humidity !== undefined) {
                document.getElementById('envHumidity').textContent = `${weatherData.humidity}%`;
                const humidityFill = document.getElementById('humidityFillBar');
                if (humidityFill) {
                    // Animate the fill
                    setTimeout(() => {
                        humidityFill.style.width = `${weatherData.humidity}%`;
                    }, 200);
                }
                
                const humidityStatus = getHumidityStatus(weatherData.humidity);
                const humidityStatusEl = document.getElementById('envHumidityStatus');
                humidityStatusEl.textContent = humidityStatus.text;
                humidityStatusEl.className = `env-status ${humidityStatus.class} ${statusClass}`;
            }
            
            // Rainfall
            if (weatherData.rainfall !== undefined) {
                document.getElementById('envRainfall').textContent = `${weatherData.rainfall.toFixed(1)} mm`;
                const rainLevel = document.getElementById('rainLevelIndicator');
                if (rainLevel) {
                    const level = Math.min(weatherData.rainfall / 50 * 100, 100);
                    // Animate the level
                    setTimeout(() => {
                        rainLevel.style.height = `${level}%`;
                    }, 400);
                }
                
                const rainfallStatus = getRainfallStatus(weatherData.rainfall);
                const rainfallStatusEl = document.getElementById('envRainfallStatus');
                rainfallStatusEl.textContent = rainfallStatus.text;
                rainfallStatusEl.className = `env-status ${rainfallStatus.class} ${statusClass}`;
            }
            
            // Air Quality
            if (weatherData.air_quality_index !== undefined) {
                document.getElementById('envAQI').textContent = weatherData.air_quality_index;
                const aqiLevel = document.getElementById('aqiLevelIndicator');
                if (aqiLevel) {
                    const level = Math.min(weatherData.air_quality_index / 500 * 100, 100);
                    // Animate the level
                    setTimeout(() => {
                        aqiLevel.style.width = `${level}%`;
                    }, 600);
                }
                
                const aqiStatus = getAQIStatus(weatherData.air_quality_index);
                const aqiStatusEl = document.getElementById('envAQIStatus');
                aqiStatusEl.textContent = aqiStatus.text;
                aqiStatusEl.className = `env-status ${aqiStatus.class} ${statusClass}`;
            }
            
            // Remove animation classes after animation completes
            setTimeout(() => {
                cards.forEach(card => card.classList.remove('instant-load'));
            }, 500);
        }
        
        // Status helper functions
        function getTemperatureStatus(temp) {
            if (temp < 10) return { text: 'Very Cold', class: 'cold' };
            if (temp < 20) return { text: 'Cool', class: 'cool' };
            if (temp < 30) return { text: 'Comfortable', class: 'comfortable' };
            if (temp < 35) return { text: 'Warm', class: 'warm' };
            if (temp < 40) return { text: 'Hot', class: 'hot' };
            return { text: 'Extreme Heat', class: 'extreme' };
        }
        
        function getHumidityStatus(humidity) {
            if (humidity < 30) return { text: 'Dry', class: 'dry' };
            if (humidity < 60) return { text: 'Comfortable', class: 'comfortable' };
            if (humidity < 80) return { text: 'Humid', class: 'humid' };
            return { text: 'Very Humid', class: 'very-humid' };
        }
        
        function getRainfallStatus(rainfall) {
            if (rainfall === 0) return { text: 'No Rain', class: 'no-rain' };
            if (rainfall < 2) return { text: 'Light Rain', class: 'light' };
            if (rainfall < 10) return { text: 'Moderate Rain', class: 'moderate' };
            if (rainfall < 30) return { text: 'Heavy Rain', class: 'heavy' };
            return { text: 'Extreme Rain', class: 'extreme' };
        }
        
        function getAQIStatus(aqi) {
            if (aqi <= 50) return { text: 'Good', class: 'good' };
            if (aqi <= 100) return { text: 'Moderate', class: 'moderate' };
            if (aqi <= 150) return { text: 'Unhealthy for Sensitive', class: 'unhealthy-sensitive' };
            if (aqi <= 200) return { text: 'Unhealthy', class: 'unhealthy' };
            if (aqi <= 300) return { text: 'Very Unhealthy', class: 'very-unhealthy' };
            return { text: 'Hazardous', class: 'hazardous' };
        }
        
        // Initialize dashboard with IMMEDIATE loading
        function initializeDashboard() {
            console.log('‚ö° Instant Dashboard Initialization Started...');
            
            // IMMEDIATE: Show UI and sample data instantly
            initializeImmediateUI();
            
            // PROGRESSIVE: Load real data in background
            // No blocking operations here
        }
        
        // Initialize when page loads - INSTANT RESPONSE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚ö° DOM Ready - Starting INSTANT Dashboard...');
            
            // Start immediate initialization (no delays)
            initializeDashboard();
            
            // Add event listeners for alerts page
            document.getElementById('locationSearchAlerts').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocationAlerts();
                }
            });
            
            document.getElementById('citySelectAlerts').addEventListener('change', function(e) {
                selectLocationAlerts();
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                const searchContainer = document.querySelector('.location-search-section');
                const searchResults = document.getElementById('searchResultsAlerts');
                if (searchContainer && !searchContainer.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        });

        // =============== ENVIRONMENTAL CONDITIONS API INTEGRATION ===============
        
        let availableCitiesAlerts = [];
        let currentLocationAlerts = 'Delhi';
        let lastEnvironmentalFetch = 0;
        const ENVIRONMENTAL_FETCH_COOLDOWN = 5000; // 5 seconds
        
        // Load available cities for alerts page
        async function loadCitiesForAlerts() {
            try {
                console.log('Loading cities for alerts page...');
                const response = await fetch('http://localhost:4002/api/weather/cities?limit=20');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    availableCitiesAlerts = result.data;
                    populateCityDropdownAlerts(availableCitiesAlerts);
                    console.log(`Loaded ${availableCitiesAlerts.length} cities for alerts`);
                    
                    // Auto-load Delhi environmental data
                    loadEnvironmentalDataAlerts(currentLocationAlerts);
                } else {
                    console.error('Failed to load cities:', result.error);
                    // Use fallback cities
                    availableCitiesAlerts = getFallbackCitiesAlerts();
                    populateCityDropdownAlerts(availableCitiesAlerts);
                    loadEnvironmentalDataAlerts(currentLocationAlerts);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
                availableCitiesAlerts = getFallbackCitiesAlerts();
                populateCityDropdownAlerts(availableCitiesAlerts);
                loadEnvironmentalDataAlerts(currentLocationAlerts);
            }
        }
        
        // Populate city dropdown for alerts
        function populateCityDropdownAlerts(cities) {
            const citySelect = document.getElementById('citySelectAlerts');
            citySelect.innerHTML = '<option value="">üè° Select a location</option>';
            
            cities.forEach(city => {
                const typeIcon = getLocationTypeIconAlerts(city.type || 'Town');
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = `${typeIcon} ${city.name} (${city.state || 'India'})`;
                option.dataset.cityData = JSON.stringify(city);
                citySelect.appendChild(option);
            });
        }
        
        // Get fallback cities for alerts
        function getFallbackCitiesAlerts() {
            return [
                { id: 1, name: 'Delhi', state: 'Delhi', type: 'Capital' },
                { id: 2, name: 'Mumbai', state: 'Maharashtra', type: 'City' },
                { id: 3, name: 'Bangalore', state: 'Karnataka', type: 'City' },
                { id: 4, name: 'Chennai', state: 'Tamil Nadu', type: 'City' },
                { id: 5, name: 'Kolkata', state: 'West Bengal', type: 'City' },
                { id: 6, name: 'Mandla', state: 'Madhya Pradesh', type: 'Town' },
                { id: 7, name: 'Dharamshala', state: 'Himachal Pradesh', type: 'Hill Station' },
                { id: 8, name: 'Raichur', state: 'Karnataka', type: 'Town' }
            ];
        }
        
        // Get location type icon for alerts
        function getLocationTypeIconAlerts(type) {
            const icons = {
                'Capital': 'üèõÔ∏è',
                'City': 'üèôÔ∏è',
                'Town': 'üèòÔ∏è',
                'Hill Station': '‚õ∞Ô∏è',
                'Desert Town': 'üèúÔ∏è',
                'Coastal Town': 'üèñÔ∏è'
            };
            return icons[type] || 'üèòÔ∏è';
        }
        
        // Search location for alerts
        async function searchLocationAlerts() {
            const searchInput = document.getElementById('locationSearchAlerts');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a location to search');
                return;
            }
            
            const searchResults = document.getElementById('searchResultsAlerts');
            searchResults.innerHTML = '<div class="search-loading">üîç Searching...</div>';
            searchResults.style.display = 'block';
            
            try {
                // Search in loaded cities first
                const localResults = availableCitiesAlerts.filter(city => 
                    city.name.toLowerCase().includes(query.toLowerCase()) ||
                    (city.state && city.state.toLowerCase().includes(query.toLowerCase()))
                );
                
                displaySearchResultsAlerts(localResults);
                
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="search-error">‚ùå Search failed</div>';
            }
        }
        
        // Display search results for alerts
        function displaySearchResultsAlerts(results) {
            const searchResults = document.getElementById('searchResultsAlerts');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results">‚ùå No locations found</div>';
                return;
            }
            
            let html = '';
            results.forEach(city => {
                const typeIcon = getLocationTypeIconAlerts(city.type || 'Town');
                html += `
                    <div class="search-result-item" onclick="selectSearchResultAlerts('${city.name}', '${city.type || 'Town'}', '${city.state || 'India'}')">
                        <div class="result-icon">${typeIcon}</div>
                        <div class="result-info">
                            <div class="result-name">${city.name}</div>
                            <div class="result-details">${city.state || 'India'} ‚Ä¢ ${city.type || 'Town'}</div>
                        </div>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
        }
        
        // Select search result for alerts
        function selectSearchResultAlerts(cityName, cityType, stateName) {
            document.getElementById('locationSearchAlerts').value = cityName;
            document.getElementById('citySelectAlerts').value = cityName;
            document.getElementById('searchResultsAlerts').style.display = 'none';
            
            // Update current location display
            document.getElementById('currentLocationNameAlerts').textContent = cityName;
            document.getElementById('currentLocationTypeAlerts').textContent = `${cityType}, ${stateName}`;
            
            currentLocationAlerts = cityName;
            
            // Load environmental data for selected location
            loadEnvironmentalDataAlerts(cityName);
        }
        
        // Select location from dropdown
        function selectLocationAlerts() {
            const citySelect = document.getElementById('citySelectAlerts');
            const selectedCity = citySelect.value;
            
            if (selectedCity) {
                const cityData = JSON.parse(citySelect.selectedOptions[0].dataset.cityData || '{}');
                document.getElementById('currentLocationNameAlerts').textContent = cityData.name || selectedCity;
                document.getElementById('currentLocationTypeAlerts').textContent = `${cityData.type || 'Town'}, ${cityData.state || 'India'}`;
                
                currentLocationAlerts = selectedCity;
                loadEnvironmentalDataAlerts(selectedCity);
            }
        }
        
        // Load environmental data for alerts page
        async function loadEnvironmentalDataAlerts(cityName) {
            if (!cityName) return;
            
            // Prevent rapid successive calls
            const now = Date.now();
            if (now - lastEnvironmentalFetch < ENVIRONMENTAL_FETCH_COOLDOWN) {
                console.log(`Skipping environmental fetch for ${cityName} - too soon`);
                return;
            }
            lastEnvironmentalFetch = now;
            
            try {
                showEnvironmentalLoading();
                
                console.log(`Fetching environmental data for ${cityName}...`);
                const response = await fetch(`http://localhost:4002/api/weather/current/${cityName}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const weather = result.data;
                    
                    // Check if we have OpenWeather data
                    if (weather.openWeatherData && weather.openWeatherData.data) {
                        const data = weather.openWeatherData.data;
                        const environmentalData = {
                            temperature: parseFloat(data.main.temp),
                            temp_min: parseFloat(data.main.temp_min),
                            temp_max: parseFloat(data.main.temp_max),
                            humidity: Math.round(data.main.humidity),
                            rainfall: parseFloat(data.rain?.['1h'] || 0),
                            air_quality_index: Math.round(data.main.pressure / 10) // Mock AQI based on pressure
                        };
                        
                        updateEnvironmentalDisplayAlerts(environmentalData);
                        console.log('Successfully updated environmental data for', cityName);
                    } else {
                        console.warn('No weather data in response for', cityName);
                        // Try database fallback
                        await loadEnvironmentalDataFromDBAlerts(cityName);
                    }
                } else {
                    console.error('API returned error:', result.error);
                    showEnvironmentalError('Failed to load environmental data: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error fetching environmental data:', error);
                showEnvironmentalError('Unable to connect to server. Please check if the server is running.');
            }
        }
        
        // Fallback: try database for environmental data
        async function loadEnvironmentalDataFromDBAlerts(cityName) {
            try {
                console.log(`Trying cached environmental data for ${cityName}...`);
                const response = await fetch(`http://localhost:4002/api/weather/latest/${cityName}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const data = result.data;
                        const environmentalData = {
                            temperature: data.temperature || 25,
                            temp_min: data.temp_min || 20,
                            temp_max: data.temp_max || 30,
                            humidity: data.humidity || 60,
                            rainfall: data.rainfall || 0,
                            air_quality_index: data.air_quality_index || 50
                        };
                        
                        updateEnvironmentalDisplayAlerts(environmentalData);
                        console.log('Using cached environmental data for', cityName);
                        return;
                    }
                }
                
                showEnvironmentalError(`No environmental data for ${cityName}. Server may be starting up...`);
            } catch (error) {
                console.error('Database fallback failed:', error);
                showEnvironmentalError('No data available');
            }
        }
        
        // Show loading state for environmental conditions
        function showEnvironmentalLoading() {
            const loadingElements = [
                { id: 'envTemperature', text: '--¬∞C' },
                { id: 'envHumidity', text: '--%' },
                { id: 'envRainfall', text: '-- mm' },
                { id: 'envAQI', text: '--' },
                { id: 'envTempStatus', text: 'Loading...' },
                { id: 'envHumidityStatus', text: 'Loading...' },
                { id: 'envRainfallStatus', text: 'Loading...' },
                { id: 'envAQIStatus', text: 'Loading...' },
                { id: 'tempMin', text: '--' },
                { id: 'tempMax', text: '--' }
            ];
            
            loadingElements.forEach(element => {
                const el = document.getElementById(element.id);
                if (el) {
                    el.textContent = element.text;
                    el.style.opacity = '0.6';
                }
            });
        }
        
        // Update environmental display with real data
        function updateEnvironmentalDisplayAlerts(data) {
            // Temperature
            document.getElementById('envTemperature').textContent = `${data.temperature.toFixed(1)}¬∞C`;
            document.getElementById('tempMin').textContent = data.temp_min?.toFixed(1) || '--';
            document.getElementById('tempMax').textContent = data.temp_max?.toFixed(1) || '--';
            
            const tempStatus = getTemperatureStatusAlerts(data.temperature);
            const tempStatusEl = document.getElementById('envTempStatus');
            tempStatusEl.textContent = tempStatus.text;
            tempStatusEl.className = `env-status ${tempStatus.class}`;
            
            // Humidity
            document.getElementById('envHumidity').textContent = `${data.humidity}%`;
            const humidityFill = document.getElementById('humidityFillBar');
            if (humidityFill) {
                humidityFill.style.width = `${data.humidity}%`;
            }
            
            const humidityStatus = getHumidityStatusAlerts(data.humidity);
            const humidityStatusEl = document.getElementById('envHumidityStatus');
            humidityStatusEl.textContent = humidityStatus.text;
            humidityStatusEl.className = `env-status ${humidityStatus.class}`;
            
            // Rainfall
            document.getElementById('envRainfall').textContent = `${data.rainfall.toFixed(1)} mm`;
            const rainLevel = document.getElementById('rainLevelIndicator');
            if (rainLevel) {
                const level = Math.min(data.rainfall / 50 * 100, 100);
                rainLevel.style.height = `${level}%`;
            }
            
            const rainfallStatus = getRainfallStatusAlerts(data.rainfall);
            const rainfallStatusEl = document.getElementById('envRainfallStatus');
            rainfallStatusEl.textContent = rainfallStatus.text;
            rainfallStatusEl.className = `env-status ${rainfallStatus.class}`;
            
            // Air Quality
            document.getElementById('envAQI').textContent = data.air_quality_index;
            const aqiLevel = document.getElementById('aqiLevelIndicator');
            if (aqiLevel) {
                const level = Math.min(data.air_quality_index / 500 * 100, 100);
                aqiLevel.style.width = `${level}%`;
            }
            
            const aqiStatus = getAQIStatusAlerts(data.air_quality_index);
            const aqiStatusEl = document.getElementById('envAQIStatus');
            aqiStatusEl.textContent = aqiStatus.text;
            aqiStatusEl.className = `env-status ${aqiStatus.class}`;
            
            // Restore opacity
            document.querySelectorAll('.env-value, .env-status').forEach(el => {
                el.style.opacity = '1';
            });
        }
        
        // Status helper functions for alerts
        function getTemperatureStatusAlerts(temp) {
            if (temp < 10) return { text: 'Very Cold', class: 'cold' };
            if (temp < 20) return { text: 'Cool', class: 'cool' };
            if (temp < 30) return { text: 'Comfortable', class: 'comfortable' };
            if (temp < 35) return { text: 'Warm', class: 'warm' };
            if (temp < 40) return { text: 'Hot', class: 'hot' };
            return { text: 'Extreme Heat', class: 'extreme' };
        }
        
        function getHumidityStatusAlerts(humidity) {
            if (humidity < 30) return { text: 'Dry', class: 'dry' };
            if (humidity < 60) return { text: 'Comfortable', class: 'comfortable' };
            if (humidity < 80) return { text: 'Humid', class: 'humid' };
            return { text: 'Very Humid', class: 'very-humid' };
        }
        
        function getRainfallStatusAlerts(rainfall) {
            if (rainfall === 0) return { text: 'No Rain', class: 'no-rain' };
            if (rainfall < 2) return { text: 'Light Rain', class: 'light' };
            if (rainfall < 10) return { text: 'Moderate Rain', class: 'moderate' };
            if (rainfall < 30) return { text: 'Heavy Rain', class: 'heavy' };
            return { text: 'Extreme Rain', class: 'extreme' };
        }
        
        function getAQIStatusAlerts(aqi) {
            if (aqi <= 50) return { text: 'Good', class: 'good' };
            if (aqi <= 100) return { text: 'Moderate', class: 'moderate' };
            if (aqi <= 150) return { text: 'Unhealthy for Sensitive', class: 'unhealthy-sensitive' };
            if (aqi <= 200) return { text: 'Unhealthy', class: 'unhealthy' };
            if (aqi <= 300) return { text: 'Very Unhealthy', class: 'very-unhealthy' };
            return { text: 'Hazardous', class: 'hazardous' };
        }
        
        // Show environmental error
        function showEnvironmentalError(message) {
            console.error('Environmental error:', message);
            document.getElementById('envTemperature').textContent = 'Error';
            document.getElementById('envHumidity').textContent = 'Error';
            document.getElementById('envRainfall').textContent = 'Error';
            document.getElementById('envAQI').textContent = 'Error';
            document.getElementById('envTempStatus').textContent = message;
            document.getElementById('envHumidityStatus').textContent = 'Error';
            document.getElementById('envRainfallStatus').textContent = 'Error';
            document.getElementById('envAQIStatus').textContent = 'Error';
        }
        
        // Refresh environmental data
        function refreshEnvironmentalData() {
            console.log('Manual refresh of environmental data for', currentLocationAlerts);
            
            // Add visual feedback to refresh button
            const refreshBtn = document.getElementById('refreshEnvironmentalBtn');
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                
                // Disable button temporarily
                refreshBtn.disabled = true;
                refreshBtn.style.opacity = '0.7';
                if (icon) {
                    icon.style.animation = 'spin 1s linear infinite';
                }
                
                // Re-enable button after 3 seconds
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.style.opacity = '1';
                    if (icon) {
                        icon.style.animation = 'none';
                    }
                }, 3000);
            }
            
            // Reset cooldown and fetch data
            lastEnvironmentalFetch = 0;
            loadEnvironmentalDataAlerts(currentLocationAlerts);
        }
        
        // Initialize alerts environmental data system
        function initializeAlertsEnvironmental() {
            console.log('üåç Initializing environmental conditions for alerts page...');
            
            // Load cities and initial environmental data
            loadCitiesForAlerts();
        }
        
        // Start environmental system when page loads
        setTimeout(() => {
            initializeAlertsEnvironmental();
        }, 1000);

        // =============== ML ALERT PREDICTIONS ===============
        
        // Load ML alert predictions for selected city (updated to work with small towns)
        async function loadAlertPredictions() {
            const citySelect = document.getElementById('citySelect');
            const city = citySelect.value;
            
            if (!city) {
                alert('Please select a location first');
                return;
            }

            const predictionsSection = document.getElementById('alertPredictions');
            const generateBtn = document.getElementById('generateAlertsBtn');
            
            // Show loading state
            predictionsSection.style.display = 'grid';
            predictionsSection.innerHTML = '<div class="ml-loading"><i class="fas fa-spinner fa-spin"></i><p>Analyzing environmental risks for ' + city + '...</p></div>';
            
            // Disable button
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            try {
                const response = await fetch(`http://localhost:4001/api/ml/alerts/${city}`);
                const data = await response.json();

                if (data.success) {
                    displayAlertPredictions(data.alerts);
                } else {
                    throw new Error(data.error || 'Failed to load alert predictions');
                }
            } catch (error) {
                console.error('Error loading alert predictions:', error);
                predictionsSection.innerHTML = `<div class="ml-error">Error loading alert predictions for ${city}: ${error.message}</div>`;
            } finally {
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Predict Alerts';
            }
        }
        
        // Display alert predictions in the grid
        function displayAlertPredictions(alerts) {
            const container = document.getElementById('alertPredictions');
            let html = '';
            
            Object.entries(alerts).forEach(([alertType, alert]) => {
                const levelClass = `alert-${alert.level.toLowerCase()}`;
                const probabilityColor = getProbabilityColor(alert.probability);
                const icon = getAlertTypeIcon(alertType);
                
                html += `
                    <div class="prediction-alert-card ${levelClass}">
                        <div class="alert-type-header">
                            <div class="alert-type-icon">${icon}</div>
                            <h3 class="alert-type-name">${alertType.charAt(0).toUpperCase() + alertType.slice(1)} Alert</h3>
                        </div>
                        <div class="alert-level-display">
                            <div class="level-badge level-${alert.level.toLowerCase()}">${alert.level}</div>
                        </div>
                        <div class="probability-display">
                            <div class="probability-circle" style="background: conic-gradient(${probabilityColor} ${alert.probability * 360}deg, #e0e0e0 0deg)">
                                <div class="probability-inner">
                                    <span class="probability-value">${(alert.probability * 100).toFixed(0)}%</span>
                                    <span class="probability-label" data-i18n="probability">Probability</span>
                                </div>
                            </div>
                        </div>
                        <div class="alert-details">
                            <div class="detail-item">
                                <i class="fas fa-calendar"></i>
                                <span>Next 48 hours</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${document.getElementById('citySelect').value}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Helper functions
        function getProbabilityColor(probability) {
            if (probability >= 0.7) return '#f44336';
            if (probability >= 0.5) return '#ff9800';
            if (probability >= 0.3) return '#ffeb3b';
            return '#4caf50';
        }
        
        function getAlertTypeIcon(alertType) {
            const icons = {
                'drought': 'üåµ',
                'flood': 'üåä',
                'heatwave': 'üî•',
                'storm': '‚õàÔ∏è',
                'cold': '‚ùÑÔ∏è',
                'cyclone': 'üåÄ'
            };
            return icons[alertType.toLowerCase()] || '‚ö†Ô∏è';
        }
        
        // Existing functions
        function getHeatwaveAlert() {
            document.getElementById('heatwave-info').innerHTML = `
                <strong data-i18n="heatwaveAlertDetails">Heatwave Alert:</strong><br>
                Current temperature: 38¬∞C<br>
                Heatwave risk level: High<br>
                Duration: 7 days<br>
                Recommendation: Stay indoors, keep hydrated, check on vulnerable individuals
            `;
            document.querySelector('.heatwave').classList.add('active');
        }

        function getFloodPrediction() {
            document.getElementById('flood-info').innerHTML = `
                <strong data-i18n="floodPredictionDetails">Flood Prediction:</strong><br>
                River level: 9.5m (critical: 10m)<br>
                Risk level: Moderate<br>
                Expected peak: 48 hours
            `;
            document.querySelector('.flood').classList.add('active');
        }

        function getDroughtWarning() {
            document.getElementById('drought-info').innerHTML = `
                <strong>Drought Warning:</strong><br>
                Soil moisture: 12%<br>
                Precipitation deficit: 30%<br>
                Duration: 3 months
            `;
            document.querySelector('.drought').classList.add('active');
        }

        function getCoastalMonitoring() {
            document.getElementById('coastal-info').innerHTML = `
                <strong>Coastal Monitoring:</strong><br>
                Storm surge: 1.2m<br>
                Wave height: 4m<br>
                Expected impact: 72 hours
            `;
            document.querySelector('.coastal').classList.add('active');
        }
    </script>
  <script src="languages.js"></script>
  <script>
    // Language change function
    function changeLanguage() {
      const select = document.getElementById('languageSelect');
      const selectedLang = select.value;
      setLanguage(selectedLang);
      // Dispatch custom event for other scripts to react
      document.dispatchEvent(new CustomEvent('languageChanged', { detail: { language: selectedLang } }));
    }
    
    // Set language selector to current language on page load
    document.addEventListener('DOMContentLoaded', function() {
      const currentLang = getCurrentLanguage();
      document.getElementById('languageSelect').value = currentLang;
      // Update language on page load
      updateLanguage(currentLang);
    });
  </script>
</body>

<!-- Dashboard Status Indicator -->
<div class="dashboard-status" id="dashboardStatus">
    <div class="status-dot connected" id="statusDot"></div>
    <span id="statusText">Connected</span>
</div>

<!-- Force Update Button -->
<button class="force-update-btn" id="forceUpdateBtn" onclick="forceRefreshDashboard()" title="Force Refresh Dashboard">
    <i class="fas fa-sync-alt"></i>
</button>

</html>